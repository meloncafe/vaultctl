#!/bin/bash
# Generated by vaultctl compose init
# Vault secret: {{ secret_name }}
# Generated at: {{ generated_at }}

set -e

COMPOSE_FILE="{{ compose_file }}"
VAULT_SECRET="{{ secret_name }}"
SECRETS_FILE="{{ secrets_file }}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}▶${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

sync_secrets() {
    print_status "Syncing secrets from Vault..."
    vaultctl env "$VAULT_SECRET" -o "$SECRETS_FILE"
}

case "$1" in
    up)
        sync_secrets
        print_status "Starting containers..."
        {{ docker_cmd }} -f "$COMPOSE_FILE" up -d "${@:2}"
        ;;
    down)
        print_status "Stopping containers..."
        {{ docker_cmd }} -f "$COMPOSE_FILE" down "${@:2}"
        ;;
    restart)
        sync_secrets
        print_status "Restarting containers..."
        {{ docker_cmd }} -f "$COMPOSE_FILE" down
        {{ docker_cmd }} -f "$COMPOSE_FILE" up -d "${@:2}"
        ;;
    pull)
        print_status "Pulling images..."
        {{ docker_cmd }} -f "$COMPOSE_FILE" pull "${@:2}"
        ;;
    logs)
        {{ docker_cmd }} -f "$COMPOSE_FILE" logs "${@:2}"
        ;;
    status|ps)
        {{ docker_cmd }} -f "$COMPOSE_FILE" ps "${@:2}"
        ;;
    sync)
        sync_secrets
        print_status "Secrets synced to $SECRETS_FILE"
        ;;
    prune)
        print_status "Cleaning up old images..."
        docker image prune -f
        ;;
    exec)
        {{ docker_cmd }} -f "$COMPOSE_FILE" exec "${@:2}"
        ;;
    *)
        echo "Usage: $0 {up|down|restart|pull|logs|status|sync|prune|exec}"
        echo ""
        echo "Commands:"
        echo "  up       Sync secrets and start containers"
        echo "  down     Stop containers"
        echo "  restart  Sync secrets and restart containers"
        echo "  pull     Pull latest images"
        echo "  logs     Show container logs (use -f for follow)"
        echo "  status   Show container status"
        echo "  sync     Sync secrets only (without restart)"
        echo "  prune    Remove unused images"
        echo "  exec     Execute command in container"
        exit 1
        ;;
esac

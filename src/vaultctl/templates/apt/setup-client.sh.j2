#!/bin/bash
# APT Repository Client Setup Script
# APT 저장소 클라이언트 설정 스크립트
# Generated by vaultctl setup apt-server
set -e

DOMAIN="{{ domain }}"
CODENAME="{{ repo_codename }}"
{% if enable_auth %}
AUTH_USER="${1:?Usage: $0 USERNAME PASSWORD}"
AUTH_PASS="${2:?Usage: $0 USERNAME PASSWORD}"
{% endif %}

echo ""
echo "============================================================"
echo "  APT Repository Client Setup"
echo "============================================================"
echo ""

{% if enable_auth %}
echo "[1/4] Adding GPG key..."
rm -f /usr/share/keyrings/internal-apt.gpg
curl -fsSL -u "$AUTH_USER:$AUTH_PASS" "https://$DOMAIN/key.gpg" | \
    gpg --dearmor -o /usr/share/keyrings/internal-apt.gpg

echo "[2/4] Configuring authentication..."
mkdir -p /etc/apt/auth.conf.d
cat > /etc/apt/auth.conf.d/internal.conf << EOF
machine $DOMAIN
login $AUTH_USER
password $AUTH_PASS
EOF
chmod 600 /etc/apt/auth.conf.d/internal.conf

echo "[3/4] Adding APT source..."
echo "deb [signed-by=/usr/share/keyrings/internal-apt.gpg] https://$DOMAIN $CODENAME main" > \
    /etc/apt/sources.list.d/internal.list

echo "[4/4] Updating package list..."
{% else %}
echo "[1/3] Adding GPG key..."
rm -f /usr/share/keyrings/internal-apt.gpg
curl -fsSL "https://$DOMAIN/key.gpg" | \
    gpg --dearmor -o /usr/share/keyrings/internal-apt.gpg

echo "[2/3] Adding APT source..."
echo "deb [signed-by=/usr/share/keyrings/internal-apt.gpg] https://$DOMAIN $CODENAME main" > \
    /etc/apt/sources.list.d/internal.list

echo "[3/3] Updating package list..."
{% endif %}
apt-get update -qq

echo ""
echo "Setup complete! Install with: sudo apt install vaultctl"
